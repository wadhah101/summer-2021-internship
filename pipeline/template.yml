---
AWSTemplateFormatVersion: "2010-09-09"
Description: CodePipeline with CodeBuild workflow to run TaskCat ,  cfn-lint , cfn-nag
Transform: AWS::Serverless-2016-10-31
Parameters:
  RoleStackName:
    Type: String
    Default: cfn-lint-pipeline-roles

  MessagingStackName:
    Type: String
    Default: cfn-lint-pipeline-messaging

  StorageStackName:
    Type: String
    Default: cfn-lint-pipeline-storage

  AppSAMTemplateFile:
    Type: String
    Description: location of the sam file to test and deploy
    Default: app.template.yml

  SelfRepo:
    Type: String
    Default: cfn-test-lint-pipeline

  InfraRepo:
    Type: String
    Default: intership-sam-template-demo

  InfraRepoBranch:
    Type: String
    Default: master

Resources:
  CFNLintBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Description: Run CFN-lint
      ServiceRole:
        Fn::ImportValue: !Join ["-", [!Ref RoleStackName, CodeBuildRoleArn]]

      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: "masahide/cfn-python-lint"
        EnvironmentVariables:
          - Name: CODEPIPELINE_EX_ID
            Value: "#{codepipeline.PipelineExecutionId}"
          - Name: SAM_TEMPLATE_FILE
            Value: !Ref AppSAMTemplateFile
      Source:
        Type: CODEPIPELINE
        BuildSpec: pipeline/buildspecs/cfn-lint.buildspec.yml
      TimeoutInMinutes: 10

  CFNNAGBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Description: Run CFN-lint
      ServiceRole:
        Fn::ImportValue: !Join ["-", [!Ref RoleStackName, CodeBuildRoleArn]]

      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: "stelligent/cfn_nag"
        EnvironmentVariables:
          - Name: SAM_TEMPLATE_FILE
            Value: !Ref AppSAMTemplateFile
      Source:
        Type: CODEPIPELINE
        BuildSpec: pipeline/buildspecs/cfn-nag.buildspec.yml
      TimeoutInMinutes: 10

  TaskCatBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Description: Run TaskCat
      ServiceRole:
        Fn::ImportValue: !Join ["-", [!Ref RoleStackName, CodeBuildRoleArn]]

      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: "taskcat/taskcat"
        PrivilegedMode: true
        EnvironmentVariables:
          - Name: SAM_TEMPLATE_FILE
            Value: !Ref AppSAMTemplateFile
      Source:
        Type: CODEPIPELINE
        BuildSpec: pipeline/buildspecs/taskcat.buildspec.yml
      TimeoutInMinutes: 60

  PackageSamBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Description: Package sam file
      ServiceRole:
        Fn::ImportValue: !Join ["-", [!Ref RoleStackName, CodeBuildRoleArn]]

      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: "aws/codebuild/standard:5.0"
        EnvironmentVariables:
          - Name: BUCKET_NAME
            Value:
              Fn::ImportValue: !Sub "${StorageStackName}-CodeBucketID"

          - Name: SAM_TEMPLATE_FILE
            Value: !Ref AppSAMTemplateFile
      Source:
        Type: CODEPIPELINE
        BuildSpec: pipeline/buildspecs/package.buildspec.yml
      TimeoutInMinutes: 60

  SAMBuildDeploy:
    Type: AWS::CodeBuild::Project
    Properties:
      Description: Run sam
      ServiceRole:
        Fn::ImportValue: !Join ["-", [!Ref RoleStackName, CodeBuildRoleArn]]

      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: "aws/codebuild/standard:5.0"
        EnvironmentVariables:
          - Name: BUCKET_NAME
            Value:
              Fn::ImportValue: !Sub "${StorageStackName}-CodeBucketID"

          - Name: SAM_TEMPLATE_FILE
            Value: !Ref AppSAMTemplateFile
      Source:
        Type: CODEPIPELINE
        BuildSpec: pipeline/buildspecs/app.buildspec.yml
      TimeoutInMinutes: 10

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn:
        Fn::ImportValue: !Join ["-", [!Ref RoleStackName, CodePipelineRoleArn]]

      Stages:
        - Name: CodeSourcing
          Actions:
            - InputArtifacts: []
              Name: ProjectSource
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: "1"
                Provider: CodeCommit
              OutputArtifacts:
                - Name: ProjectSourceCode
              Configuration:
                RepositoryName: !Ref InfraRepo
                BranchName: !Ref InfraRepoBranch

            - InputArtifacts: []
              Name: PipelineSource
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: "1"
                Provider: CodeCommit
              OutputArtifacts:
                - Name: PipelineSourceCode
              Configuration:
                RepositoryName: !Ref SelfRepo
                BranchName: !Ref InfraRepoBranch

        - Name: Packaging
          Actions:
            - InputArtifacts:
                - Name: PipelineSourceCode
                - Name: ProjectSourceCode
              OutputArtifacts:
                - Name: PackagingArtifacts
              Name: PackageSam
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref PackageSamBuild
                PrimarySource: PipelineSourceCode

        - Name: LintingTesting
          Actions:
            - InputArtifacts:
                - Name: PipelineSourceCode
                - Name: PackagingArtifacts
              OutputArtifacts:
                - Name: LintingArtifacts
              Name: LintSam
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref CFNLintBuild
                PrimarySource: PipelineSourceCode
              RunOrder: 1

            - InputArtifacts:
                - Name: PipelineSourceCode
                - Name: PackagingArtifacts
              OutputArtifacts:
                - Name: NagArtifacts
              Name: NagSam
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref CFNNAGBuild
                PrimarySource: PipelineSourceCode
              RunOrder: 1

            - InputArtifacts:
                - Name: PipelineSourceCode
                - Name: PackagingArtifacts
              OutputArtifacts:
                - Name: taskcatArtifacts
              Name: Taskcat
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TaskCatBuild
                PrimarySource: PipelineSourceCode
              RunOrder: 1

        - Name: UploadLintingResult
          Actions:
            - InputArtifacts:
                - Name: taskcatArtifacts
              Name: TaskCatUpload
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: S3
              Configuration:
                BucketName:
                  Fn::ImportValue: !Sub "${StorageStackName}-LintingBucketID"

                Extract: true
              RunOrder: 1

            - InputArtifacts:
                - Name: LintingArtifacts
              Name: CFNLintUpload
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: S3
              Configuration:
                BucketName:
                  Fn::ImportValue: !Sub "${StorageStackName}-LintingBucketID"

                Extract: true
              RunOrder: 1

            - InputArtifacts:
                - Name: NagArtifacts
              Name: CFNNagUploads
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: "1"
                Provider: S3
              Configuration:
                BucketName:
                  Fn::ImportValue: !Sub "${StorageStackName}-LintingBucketID"
                Extract: true
              RunOrder: 1

        - Name: DeployDev
          Actions:
            - InputArtifacts:
                - Name: PackagingArtifacts
                - Name: ProjectSourceCode
                - Name: PipelineSourceCode
              Name: DeploySAM
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild

              Configuration:
                ProjectName: !Ref SAMBuildDeploy
                PrimarySource: PipelineSourceCode
              RunOrder: 2

        - Name: DeployStage
          Actions:
            - Name: ApproveByDeveloper
              InputArtifacts: []
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Version: "1"
                Provider: Manual
              Configuration:
                NotificationArn:
                  Fn::ImportValue:
                    !Join [
                      "-",
                      [!Ref MessagingStackName, StageNotificationSNSTopicArn],
                    ]
                CustomData: "Review and approve deploying to stage with ID #{codepipeline.PipelineExecutionId}"
                ExternalEntityLink: www.todo.com
              RunOrder: 1
            - InputArtifacts:
                - Name: PackagingArtifacts
                - Name: ProjectSourceCode
                - Name: PipelineSourceCode
              Name: DeploySAM
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref SAMBuildDeploy
                PrimarySource: PipelineSourceCode
              RunOrder: 2

        - Name: DeployProd
          Actions:
            - Name: ApproveByOwner
              InputArtifacts: []
              Configuration:
                NotificationArn:
                  Fn::ImportValue:
                    !Join [
                      "-",
                      [!Ref MessagingStackName, ProdNotificationSNSTopicArn],
                    ]
                CustomData: "Review and approve deploying to production"
                ExternalEntityLink: www.todo.com
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Version: "1"
                Provider: Manual
            - Name: DeploySAM
              InputArtifacts:
                - Name: PackagingArtifacts
                - Name: ProjectSourceCode
                - Name: PipelineSourceCode
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref SAMBuildDeploy
                PrimarySource: PipelineSourceCode
              RunOrder: 2

      ArtifactStore:
        Type: S3
        Location:
          Fn::ImportValue: !Sub "${StorageStackName}-PipelineArtifactBucketID"

Outputs:
  PipelineUrl:
    Value: !Sub https://console.aws.amazon.com/codepipeline/home?region=${AWS::Region}#/view/${Pipeline}
    Description: CodePipeline URL
  PipelineID:
    Value: !Ref Pipeline
    Export:
      Name: !Join ["-", [!Ref AWS::StackName, PipelineID]]
  PipelineArn:
    Value: !Sub "arn:${AWS::Partition}:codepipeline:${AWS::Region}:${AWS::AccountId}:${Pipeline}"
    Export:
      Name: !Join ["-", [!Ref AWS::StackName, PipelineArn]]
